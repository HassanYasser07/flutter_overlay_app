
// import 'dart:math';
//
// import 'package:flutter/material.dart';
// import 'package:flutter_overlay_window/flutter_overlay_window.dart';
// import 'package:flutter_overlay_window_example/widgets/control_button.dart';
//
// import 'ball_painter.dart';
//
// class BallGameApp extends StatefulWidget {
//   const BallGameApp({
//     Key? key,
//   }) : super(key: key);
//
//   @override
//   _BallGameState createState() => _BallGameState();
// }
//
// class _BallGameState extends State<BallGameApp> {
//   double lineLength = 250;
//   int maxReflections = 2;
//   Offset whiteBallPosition = const Offset(100, 100);
//   Offset redBallPosition = const Offset(100, 250);
//   bool isWhiteBallActive = true;
//   Offset? aimPoint;
//   double ballRadius = 20.0;
//   double tableWidth = 350;
//   double tableHeight = 300;
//   Offset? initialTouchPosition;
//   double cueAngle = 0.3;
//   double resizeThreshold = 50;
//   double angleStep = 0.09;
//   bool isResizing = false;
//   bool isResizingBottomRight = false;
//   bool isResizingTopLeft = false;
//   bool showControls = false;
//   double reflectionAngleAdjustment = 0.0;
//   bool isDraggingBall = false;
//   bool isCueRotating = false;
//   double initialCueAngle = 0.0;
//   Offset? initialCueTouchPosition;
//   double topOffset = 100;
//   double leftOffset = 100;
//
//   bool isOverlayInteractive = true;
//   Future<void> toggleOverlayInteraction() async {
//     setState(() {
//       isOverlayInteractive = !isOverlayInteractive;
//     });
//
//     // Toggle between interactive and non-interactive overlay
//     await FlutterOverlayWindow.updateFlag(
//       isOverlayInteractive ? OverlayFlag.defaultFlag : OverlayFlag.clickThrough,
//     );
//   }
//
//   Future<void> disableOverlay() async {
//     await FlutterOverlayWindow.updateFlag(OverlayFlag.clickThrough);
//   }
//
//   void updateBallPositionsAfterResize() {
//     // Use the actual rendered height of the game area for the bottom boundary
//     final double visibleHeight = MediaQuery.of(context).size.height * 0.79;
//     setState(() {
//       whiteBallPosition = Offset(
//         whiteBallPosition.dx.clamp(ballRadius, tableWidth - ballRadius),
//         whiteBallPosition.dy.clamp(ballRadius, visibleHeight - ballRadius),
//       );
//       redBallPosition = Offset(
//         redBallPosition.dx.clamp(ballRadius, tableWidth - ballRadius),
//         redBallPosition.dy.clamp(ballRadius, visibleHeight - ballRadius),
//       );
//     });
//   }
//
//   void updateOverlaySize(int newWidth, int newHeight) async {
//     bool? success = await FlutterOverlayWindow.resizeOverlay(
//       newWidth,
//       newHeight,
//       false, // ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø³Ø­Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©
//     );
//
//     if (success == true) {
//       setState(() {
//         tableWidth = newWidth.toDouble();
//         tableHeight = newHeight.toDouble();
//       });
//     }
//   }
//
//   void _toggleControls() {
//     setState(() {
//       showControls = !showControls; // âœ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
//     });
//   }
//
//   void _increaseAngle() {
//     setState(() {
//       cueAngle += angleStep;
//     });
//   }
//
//   void _decreaseAngle() {
//     setState(() {
//       cueAngle = (cueAngle - angleStep) % (2 * pi);
//     });
//   }
//
//   void _adjustReflectionAngle() {
//     setState(() {
//       reflectionAngleAdjustment += 0.1; // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³
//     });
//   }
//
//   void _adjustReflectionAngleNegative() {
//     setState(() {
//       reflectionAngleAdjustment -=
//           0.1; // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ ÙÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø¹Ø§ÙƒØ³
//     });
//   }
//
//   void _increaseLineLength() {
//     setState(() {
//       lineLength += 20;
//     });
//   }
//
//   void _decreaseLineLength() {
//     setState(() {
//       lineLength -= 20;
//     });
//   }
//
//   void _increaseMaxReflections() {
//     setState(() {
//       maxReflections += 1;
//     });
//   }
//
//   void _decreaseMaxReflections() {
//     setState(() {
//       maxReflections -= 1;
//     });
//   }
//
//   Offset settingsButtonPosition = const Offset(10, 10);
//   Offset chartButtonPosition = const Offset(60, 10);
//   bool showgrid = true;
//   @override
//   Widget build(BuildContext context) {
//     return Center(
//       child: FittedBox(
//         child: Column(
//           mainAxisAlignment: MainAxisAlignment.center,
//           children: [
//             Row(
//               children: [
//                 IconButton(
//                   icon: Icon(Icons.close),
//                   onPressed: () async {
//                     await FlutterOverlayWindow.closeOverlay();
//                   },
//                 ),
//                 IconButton(
//                   icon: Icon(
//                       showControls ? Icons.visibility_off : Icons.settings),
//                   onPressed:
//                       _toggleControls, // âœ… Ø§Ù„Ø¢Ù† ÙŠØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù†ÙØ³Ù‡Ø§
//                 ),
//               ],
//             ),
//             GestureDetector(
//               onPanUpdate: (details) {
//                 setState(() {
//                   if (initialTouchPosition != null) {
//                     if (isCueRotating) {
//                       Offset center = whiteBallPosition;
//                       Offset newTouch = details.localPosition;
//
//                       double newAngle = atan2(
//                           newTouch.dy - center.dy, newTouch.dx - center.dx);
//                       double oldAngle = atan2(
//                           initialCueTouchPosition!.dy - center.dy,
//                           initialCueTouchPosition!.dx - center.dx);
//
//                       double angleDifference = newAngle - oldAngle ;
//                       cueAngle = (initialCueAngle + angleDifference) % (2 * pi);
//                     }
//
//                     else if (isResizing) {
//
//
//                      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ‚ÙˆÙ… Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… ÙÙ‚Ø·
//                       double deltaX =details.localPosition.dx - initialTouchPosition!.dx;
//                       double deltaY =details.localPosition.dy - initialTouchPosition!.dy;
//
//                       tableWidth = (tableWidth + deltaX).clamp(150, 400);
//                       tableHeight = (tableHeight + deltaY).clamp(200, 800);
//                       updateOverlaySize(
//                           tableWidth.toInt(), tableHeight.toInt());
//                      updateBallPositionsAfterResize();
//                       initialTouchPosition = details.localPosition;
//                     }
//
//
//
//
//                     else if (isDraggingBall) {
//                       // âœ… ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø­Ø¨ Ø§Ù„ÙƒØ±Ø© Ù†ÙØ³Ù‡Ø§
//                       if (isWhiteBallActive) {
//                         // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¯Ø£ Ù…Ù† Ø¹Ù„ÙŠÙ‡Ø§
//                         final newWhitePosition =
//                             whiteBallPosition + details.delta;
//                         whiteBallPosition = Offset(
//                           newWhitePosition.dx
//                               .clamp(ballRadius, tableWidth - ballRadius),
//                           newWhitePosition.dy
//                               .clamp(ballRadius, tableHeight - ballRadius),
//                         );
//                       } else {
//                         // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¯Ø£ Ù…Ù† Ø¹Ù„ÙŠÙ‡Ø§
//                         final newRedPosition = redBallPosition + details.delta;
//                         redBallPosition = Offset(
//                           newRedPosition.dx
//                               .clamp(ballRadius, tableWidth - ballRadius),
//                           newRedPosition.dy
//                               .clamp(ballRadius, tableHeight - ballRadius),
//                         );
//                       }
//                     }
//                   }
//                 });
//               },
//               onPanStart: (details) {
//                 setState(() {
//                   initialTouchPosition = details.localPosition;
//                   double dx = details.localPosition.dx;
//                   double dy = details.localPosition.dy;
//                   double distanceFromWhiteBall =
//                       (details.localPosition - whiteBallPosition).distance;
//
//                   // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯Ø§Ø®Ù„ Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡
//                   if ((dx - whiteBallPosition.dx).abs() < ballRadius &&
//                       (dy - whiteBallPosition.dy).abs() < ballRadius) {
//                     isWhiteBallActive = true;
//                     isDraggingBall =
//                         true; // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙƒØ±Ø©
//                   }
//                   else if (dx > tableWidth - resizeThreshold &&
//                       dy > tableHeight - resizeThreshold) {
//                     isResizing = true;
//                     isResizingBottomRight = true; // ØªØºÙŠÙŠØ± Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ ÙÙ‚Ø·
//                     isResizingTopLeft = false;
//                   } else if (dx < resizeThreshold && dy < resizeThreshold) {
//                     isResizing = true;
//                     isResizingBottomRight = false;
//                     isResizingTopLeft = true; // ØªØºÙŠÙŠØ± Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙÙ‚Ø·
//                   }
//
//                   // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯Ø§Ø®Ù„ Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡
//                   else if ((dx - redBallPosition.dx).abs() < ballRadius &&
//                       (dy - redBallPosition.dy).abs() < ballRadius) {
//                     isWhiteBallActive = false;
//                     isDraggingBall =
//                         true; // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙƒØ±Ø©
//                   }
//                   // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ù‚Ø·Ø© Ø§Ù„Ù„Ù…Ø³ Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… (Ø£Ø³ÙÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†)
//                   else if (dx > tableWidth - resizeThreshold &&
//                       dy > tableHeight - resizeThreshold) {
//                     isResizing = true;
//                   }
//                   // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ù‚Ø·Ø© Ø§Ù„Ù„Ù…Ø³ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰
//                   else if (dx < resizeThreshold && dy < resizeThreshold) {
//                     isResizing = true;
//                   } else if (distanceFromWhiteBall > ballRadius &&
//                       distanceFromWhiteBall <= ballRadius + 150) {
//                     isCueRotating = true; // âœ… ØªÙØ¹ÙŠÙ„ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹ØµØ§
//                     isWhiteBallActive = false;
//                     //  isRedBallActive = false;     //////////////////////////////////////////////////////////////////////
//                     //  isResizingTable = false;
//                     initialCueTouchPosition =
//                         details.localPosition; // âœ… ØªØ®Ø²ÙŠÙ† Ù†Ù‚Ø·Ø© Ø§Ù„Ù„Ù…Ø³ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
//                     initialCueAngle = cueAngle; // âœ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ø¹ØµØ§
//                   } else {
//                     isResizing = false;
//                     isDraggingBall =
//                         false; // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙƒØ±Ø©
//                   }
//                 });
//               },
//               onPanEnd: (details) {
//                 setState(() {
//
//                   isResizing = false;
//                   isDraggingBall = false; // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙƒØ±Ø©
//                   isCueRotating = false;
//                   isResizingBottomRight = false;
//                   isResizingTopLeft = false;
//                   initialCueTouchPosition = null;
//                   initialTouchPosition = null;
//
//                 });
//               },
//               child: Stack(
//                 children: [
//                   CustomPaint(
//                     size: Size(tableWidth, tableHeight),
//                     painter: BallPainter(
//                       whiteBallPosition: whiteBallPosition,
//                       redBallPosition: redBallPosition,
//                       aimPoint: aimPoint,
//                       cueAngle: cueAngle,
//                       reflectionAngleAdjustment: reflectionAngleAdjustment,
//                       ballRadius: ballRadius,
//                       lineLength: lineLength,
//                       maxReflections: maxReflections,
//                     ),
//                   ),
//
//                   Positioned(
//                     bottom: 0,
//                     right: 0,
//                     child: Container(
//                       width: resizeThreshold,
//                       height: resizeThreshold,
//                       color: Colors.blue.withValues(alpha: 0.5),
//                     ),
//                   ),
//                   Positioned(
//                     top: 0,
//                     left: 0,
//                     child: Container(
//                       width: resizeThreshold,
//                       height: resizeThreshold,
//                       color: Colors.red.withValues(alpha: 0.5),
//                     ),
//                   ),
//                   Visibility(
//                     visible: showControls,
//                     child: Positioned(
//                       bottom: 10,
//                       left: 10,
//                       right: 10,
//                       child: Column(
//                         children: [
//                           Wrap(
//                             spacing: 5,
//                             runSpacing: 5,
//                             alignment: WrapAlignment.center,
//                             children: [
//                               ControlButton(
//                                 icon: Icons.add_circle,
//                                 label: 'Enlarge',
//                                 onPressed: () {
//                                   setState(() {
//                                     ballRadius = (ballRadius + 5).clamp(10, 35);
//                                   });
//                                 },
//                               ),
//                               ControlButton(
//                                 icon: Icons.remove_circle,
//                                 label: 'Shrink',
//                                 onPressed: () {
//                                   setState(() {
//                                     ballRadius = (ballRadius - 5).clamp(10, 35);
//                                   });
//                                 },
//                               ),
//                               ControlButton(
//                                 icon: Icons.rotate_right,
//                                 label: 'Increase Angle',
//                                 onPressed: _increaseAngle,
//                               ),
//                               ControlButton(
//                                 icon: Icons.rotate_left,
//                                 label: 'Decrease Angle',
//                                 onPressed: _decreaseAngle,
//                               ),
//                               ControlButton(
//                                 icon: Icons.arrow_upward,
//                                 label: 'Reflect',
//                                 onPressed: _adjustReflectionAngle,
//                               ),
//                               ControlButton(
//                                 icon: Icons.arrow_downward,
//                                 label: 'Reflect',
//                                 onPressed: _adjustReflectionAngleNegative,
//                               ),
//                               ControlButton(
//                                 icon: Icons.arrow_upward,
//                                 label: 'Increase line len',
//                                 onPressed: _increaseLineLength,
//                               ),
//                               ControlButton(
//                                 icon: Icons.arrow_downward,
//                                 label: 'Decrease line len',
//                                 onPressed: _decreaseLineLength,
//                               ),
//                               ControlButton(
//                                 icon: Icons.arrow_upward,
//                                 label: 'Increase max ref',
//                                 onPressed: _increaseMaxReflections,
//                               ),
//                               ControlButton(
//                                 icon: Icons.arrow_downward,
//                                 label: 'Decrease max ref',
//                                 onPressed: _decreaseMaxReflections,
//                               ),
//                             ],
//                           ),
//                         ],
//                       ),
//                     ),
//                   ),
//                 ],
//               ),
//             )
//           ],
//         ),
//       ),
//     );
//   }
// }
//
//
// //


//   void updateOverlaySize(int newWidth, int newHeight) async {
//     bool? success = await FlutterOverlayWindow.resizeOverlay(
//       newWidth,
//       newHeight,
//       false, // ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø³Ø­Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©
//     );
//
//     if (success == true) {
//       setState(() {
//         tableWidth = newWidth.toDouble();
//         tableHeight = newHeight.toDouble();
//       });
//     }
//   }


import 'dart:math';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_overlay_window/flutter_overlay_window.dart';
import 'package:flutter_overlay_window_example/widgets/control_button.dart';

import 'ball_painter.dart';

class BallGameApp extends StatefulWidget {
  const BallGameApp({
    Key? key,
  }) : super(key: key);

  @override
  _BallGameState createState() => _BallGameState();
}

class _BallGameState extends State<BallGameApp> {
  double lineLength = 250;
  int maxReflections = 2;
  Offset yellowBallPosition = const Offset(100, 100);
  Offset redBallPosition = const Offset(100, 250);
  bool isYellowBallActive = true;
  Offset? aimPoint;
  double ballRadius = 20.0;
  double tableWidth = 200;
  double tableHeight = 200;
  Offset? initialTouchPosition;
  double cueAngle = 0.3;
  double resizeThreshold = 50;
  double angleStep = 0.09;
  bool isResizing = false;
  bool isResizingBottomRight = false;
  bool isResizingTopLeft = false;
  bool showControls = false;
  double reflectionAngleAdjustment = 0.0;
  bool isDraggingBall = false;
  bool isCueRotating = false;
  double initialCueAngle = 0.0;
  Offset? initialCueTouchPosition;

  bool isOverlayInteractive = true;
  Offset cueStart = const Offset(100, 100);
  double cueLength = 100;
  bool isFirstResize = true;
//DateTime? expirationDate;

  @override
  void initState() {
    updateBallPositionsAfterResize();
    super.initState();
   //   checkAppExpiration();

  }

// Future<void> checkAppExpiration() async {
//   // Set your expiration date here (year, month, day, hour, minute)
//   expirationDate = DateTime(2025, 3, 18, 5, 37); // Change this to your desired date
//
//   if (DateTime.now().isAfter(expirationDate!)) {
//     showDialog(
//       context: context,
//       barrierDismissible: false,
//       builder: (BuildContext context) {
//         return AlertDialog(
//           title: Text('ØªÙ†Ø¨ÙŠÙ‡'),
//           content: Text('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'),
//           actions: <Widget>[
//             TextButton(
//               child: Text('Ø¥ØºÙ„Ø§Ù‚'),
//               onPressed: () {
//                 SystemNavigator.pop(); // This will close the app
//               },
//             ),
//           ],
//         );
//       },
//     );
//   }
// }

  void _resizeOverlayWindow() async {
    try {
      int newWidth = tableWidth.toInt().clamp(200, 600);  // Ø­Ø¯ Ø£Ø¯Ù†Ù‰ 200 ÙˆØ­Ø¯ Ø£Ù‚ØµÙ‰ 600
      int newHeight = tableHeight.toInt().clamp(200, 600);

      print("Resizing overlay to: width=$newWidth, height=$newHeight"); // Ù„Ù„ØªØµØ­ÙŠØ­

      bool? success = await FlutterOverlayWindow.resizeOverlay(
         newWidth,
         newHeight,
         false,

      );

      print("Resize success: $success");
    } catch (e) {
      print("Error resizing overlay: $e");
    }
  }

Future<void> updateOverlaySize(int newWidth, int newHeight) async {
  if (!mounted) return;
  
  // Add minimum size constraints
  if (newWidth < 150) newWidth = 150;
  if (newHeight < 200) newHeight = 200;
  
  try {
    bool? success = await FlutterOverlayWindow.resizeOverlay(
      newWidth,
      newHeight,
      true, // Enable dragging within window
    );

    if (success == true && mounted) {
      setState(() {
        tableWidth = newWidth.toDouble();
        tableHeight = newHeight.toDouble();
        updateBallPositionsAfterResize();
      });
    }
  } catch (e) {
    print('Error resizing overlay: $e');
  }
}

  //
  // void _resizeOverlayWindow() async {
  //   await FlutterOverlayWindow.resizeOverlay(
  //      tableWidth.toInt(),
  //      tableHeight.toInt(),
  //     false,
  //   );
  // }

// Future<void> updateOverlaySize(int newWidth, int newHeight) async {
//   if (!mounted) return;
  
//   // Add minimum size constraints
//   if (newWidth < 150) newWidth = 150;
//   if (newHeight < 200) newHeight = 200;
  
//   try {
//     bool? success = await FlutterOverlayWindow.resizeOverlay(
//       newWidth,
//       newHeight,
//       true, // Enable dragging within window
//     );

//     if (success == true && mounted) {
//       setState(() {
//         tableWidth = newWidth.toDouble();
//         tableHeight = newHeight.toDouble();
//         updateBallPositionsAfterResize();
//       });
//     }
//   } catch (e) {
//     print('Error resizing overlay: $e');
//   }
// }


  void _startCueRotation(DragStartDetails details) {
    Offset touchPoint = details.localPosition;

    // ğŸ”¹ ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹ØµØ§ Ø®Ø§Ø±Ø¬ Ø§Ù„ÙƒØ±Ø© Ø¨Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© (Ù…Ø«Ù„Ø§Ù‹ 10 Ø¨ÙƒØ³Ù„)
    double offsetFromBall = ballRadius + 10;
    Offset cueStart = Offset(
      yellowBallPosition.dx + cos(cueAngle) * offsetFromBall,
      yellowBallPosition.dy + sin(cueAngle) * offsetFromBall,
    );

    Offset cueEnd = Offset(
      cueStart.dx + cos(cueAngle) * (cueLength - offsetFromBall),
      cueStart.dy + sin(cueAngle) * (cueLength - offsetFromBall),
    );

    // ğŸ”¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·Ø© Ø§Ù„Ù„Ù…Ø³ ÙˆØ®Ø· Ø§Ù„Ø¹ØµØ§
    double distanceToCue = _distanceFromPointToLine(touchPoint, cueStart, cueEnd);

    if (distanceToCue <= 10) { // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹ØµØ§ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù…Ø³Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      setState(() {
        isCueRotating = true;
        initialCueTouchPosition = details.localPosition;
        initialCueAngle = cueAngle;
      });
    }
  }

// ğŸ”¹ Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·Ø© ÙˆØ®Ø· Ù…Ø³ØªÙ‚ÙŠÙ…
  double _distanceFromPointToLine(Offset point, Offset lineStart, Offset lineEnd) {
    double A = point.dx - lineStart.dx;
    double B = point.dy - lineStart.dy;
    double C = lineEnd.dx - lineStart.dx;
    double D = lineEnd.dy - lineStart.dy;

    double dot = A * C + B * D;
    double lengthSquared = C * C + D * D;
    double param = (lengthSquared != 0) ? (dot / lengthSquared) : -1;

    double nearestX, nearestY;

    if (param < 0) {
      nearestX = lineStart.dx;
      nearestY = lineStart.dy;
    } else if (param > 1) {
      nearestX = lineEnd.dx;
      nearestY = lineEnd.dy;
    } else {
      nearestX = lineStart.dx + param * C;
      nearestY = lineStart.dy + param * D;
    }

    double dx = point.dx - nearestX;
    double dy = point.dy - nearestY;
    return sqrt(dx * dx + dy * dy);
  }




  void _updateCueRotation(DragUpdateDetails details) {
    if (!isCueRotating) return; // âœ… Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¯ÙˆØ± Ø§Ù„Ø¹ØµØ§

    setState(() {
      Offset center = yellowBallPosition;
      Offset newTouch = details.localPosition;

      double newAngle = atan2(newTouch.dy - center.dy, newTouch.dx - center.dx);
      double oldAngle = atan2(
          initialCueTouchPosition!.dy - center.dy,
          initialCueTouchPosition!.dx - center.dx);

      double angleDifference = newAngle - oldAngle;
      cueAngle = (initialCueAngle + angleDifference) % (2 * pi);
    });
  }

  void _endCueRotation(DragEndDetails details) {
    setState(() {
      isCueRotating = false;
    });
  }


  Future<void> toggleOverlayInteraction() async {
    setState(() {
      isOverlayInteractive = !isOverlayInteractive;
    });

    // Toggle between interactive and non-interactive overlay
    await FlutterOverlayWindow.updateFlag(
      isOverlayInteractive ? OverlayFlag.defaultFlag : OverlayFlag.clickThrough,
    );
  }

  Future<void> disableOverlay() async {
    await FlutterOverlayWindow.updateFlag(OverlayFlag.clickThrough);
  }

  void updateBallPositionsAfterResize() {
    setState(() {
      yellowBallPosition = Offset(
        yellowBallPosition.dx.clamp(ballRadius, tableWidth - ballRadius),
        yellowBallPosition.dy.clamp(ballRadius, tableHeight - ballRadius),
      );
      redBallPosition = Offset(
        redBallPosition.dx.clamp(ballRadius, tableWidth - ballRadius),
        redBallPosition.dy.clamp(ballRadius, tableHeight - ballRadius),
      );


      // ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒØ±Ø© Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
      cueStart = Offset(
        cueStart.dx.clamp(ballRadius, tableWidth - ballRadius),
        cueStart.dy.clamp(ballRadius, tableHeight - ballRadius),
      );
    });
  }



  void _toggleControls() {
    setState(() {
      showControls = !showControls; // âœ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
    });
  }

  void _increaseAngle() {
    setState(() {
      cueAngle += angleStep;
    });
  }

  void _decreaseAngle() {
    setState(() {
      cueAngle = (cueAngle - angleStep) % (2 * pi);
    });
  }

  void _adjustReflectionAngle() {
    setState(() {
      reflectionAngleAdjustment += 0.1; // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³
    });
  }

  void _adjustReflectionAngleNegative() {
    setState(() {
      reflectionAngleAdjustment -=
      0.1; // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ ÙÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø¹Ø§ÙƒØ³
    });
  }

  void _increaseLineLength() {
    setState(() {
      lineLength += 20;
    });
  }

  void _decreaseLineLength() {
    setState(() {
      lineLength -= 20;
    });
  }

  void _increaseMaxReflections() {
    setState(() {
      maxReflections += 1;
    });
  }

  void _decreaseMaxReflections() {
    setState(() {
      maxReflections -= 1;
    });
  }

  Offset settingsButtonPosition = const Offset(10, 10);
  Offset chartButtonPosition = const Offset(60, 10);
  bool showgrid = true;

  double topOffset = 100;
  double leftOffset = 100;


  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        Positioned(
          left: leftOffset,
          top: topOffset,
          child: Container(
            color: Colors.white.withValues(alpha: .03),
            child: Stack(
              children: [
                FittedBox(
                  child: Column(
                    children: [
                      Row(
                        children: [
                          IconButton(
                            icon: Icon(Icons.close),
                            onPressed: () async {
                              await FlutterOverlayWindow.closeOverlay();
                            },
                          ),
                          IconButton(
                            icon: Icon(showControls
                                ? Icons.visibility_off
                                : Icons.settings),
                            onPressed:
                            _toggleControls, // âœ… Ø§Ù„Ø¢Ù† ÙŠØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù†ÙØ³Ù‡Ø§
                          ),
                        ],
                      ),
                      Center(
                        child: GestureDetector(
                          onPanUpdate: (details) {
                            setState(() {

                              _updateCueRotation(details );

                              if (isDraggingBall) {
                                if (isYellowBallActive) {
                                  final newWhitePosition =
                                      yellowBallPosition + details.delta;
                                  yellowBallPosition = Offset(
                                    newWhitePosition.dx.clamp(
                                        ballRadius, tableWidth - ballRadius),
                                    newWhitePosition.dy.clamp(
                                        ballRadius, tableHeight - ballRadius),
                                  );
                                } else {
                                  final newRedPosition =
                                      redBallPosition + details.delta;
                                  redBallPosition = Offset(
                                    newRedPosition.dx.clamp(
                                        ballRadius, tableWidth - ballRadius),
                                    newRedPosition.dy.clamp(
                                        ballRadius, tableHeight - ballRadius),
                                  );
                                }
                              }
                            });
                          },
                          onPanStart: (details) {
                            setState(() {
                              _startCueRotation(details);
                              double dx = details.localPosition.dx;
                              double dy = details.localPosition.dy;

                              if ((dx - yellowBallPosition.dx).abs() <
                                  ballRadius &&
                                  (dy - yellowBallPosition.dy).abs() <
                                      ballRadius) {
                                isYellowBallActive = true;
                                isDraggingBall = true;
                              } else if ((dx - redBallPosition.dx).abs() <
                                  ballRadius &&
                                  (dy - redBallPosition.dy).abs() <
                                      ballRadius) {
                                isYellowBallActive = false;
                                isDraggingBall = true;
                              }
                            });
                          },
                          onPanEnd: (details) {
                            setState(() {
                              _endCueRotation(details);
                              isDraggingBall = false;

                            });
                          },
                          child: Stack(
                            children: [
                              CustomPaint(
                                size: Size(tableWidth, tableHeight),
                                painter: BallPainter(
                                  whiteBallPosition: yellowBallPosition,
                                  redBallPosition: redBallPosition,
                                  aimPoint: aimPoint,
                                  cueAngle: cueAngle,
                                  reflectionAngleAdjustment: reflectionAngleAdjustment,
                                  ballRadius: ballRadius,
                                  lineLength: lineLength,
                                  maxReflections: maxReflections,
                                ),
                              ),
                              Visibility(
                                visible: showControls,
                                child: Positioned(
                                  bottom: 10,
                                  left: 10,
                                  right: 10,
                                  child: Column(
                                    children: [
                                      Wrap(
                                        spacing: 5,
                                        runSpacing: 5,
                                        alignment: WrapAlignment.center,
                                        children: [
                                          ControlButton(
                                            icon: Icons.add_circle,
                                            label: 'Enlarge',
                                            onPressed: () {
                                              setState(() {
                                                ballRadius = (ballRadius + 5)
                                                    .clamp(10, 35);
                                              });
                                            },
                                          ),
                                          ControlButton(
                                            icon: Icons.remove_circle,
                                            label: 'Shrink',
                                            onPressed: () {
                                              setState(() {
                                                ballRadius = (ballRadius - 5)
                                                    .clamp(10, 35);
                                              });
                                            },
                                          ),
                                          ControlButton(
                                            icon: Icons.rotate_right,
                                            label: 'Increase Angle',
                                            onPressed: _increaseAngle,
                                          ),
                                          ControlButton(
                                            icon: Icons.rotate_left,
                                            label: 'Decrease Angle',
                                            onPressed: _decreaseAngle,
                                          ),

                                          ControlButton(
                                            icon: Icons.arrow_upward,
                                            label: 'Increase line len',
                                            onPressed: _increaseLineLength,
                                          ),
                                          ControlButton(
                                            icon: Icons.arrow_downward,
                                            label: 'Decrease line len',
                                            onPressed: _decreaseLineLength,
                                          ),
                                          ControlButton(
                                            icon: Icons.arrow_upward,
                                            label: 'Increase max ref',
                                            onPressed: _increaseMaxReflections,
                                          ),
                                          ControlButton(
                                            icon: Icons.arrow_downward,
                                            label: 'Decrease max ref',
                                            onPressed: _decreaseMaxReflections,
                                          ),
                                          ControlButton(
                                            icon: Icons.arrow_upward,
                                            label: 'Reflect',
                                            onPressed: _adjustReflectionAngle,
                                          ),
                                          ControlButton(
                                            icon: Icons.arrow_downward,
                                            label: 'Reflect',
                                            onPressed:
                                            _adjustReflectionAngleNegative,
                                          ),
                                        ],
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                Positioned(
                  bottom: 0,
                  right: 0,
                  child: GestureDetector(
                    onPanUpdate: (details) {
                      setState(() {
                        tableWidth += details.delta.dx;
                        tableHeight += details.delta.dy;
                        tableWidth =
                            tableWidth.clamp(ballRadius + 30, double.infinity);
                        tableHeight =
                            tableHeight.clamp(ballRadius + 30, 600);
                      });
                      updateBallPositionsAfterResize();
                   //   updateOverlaySize(tableWidth.toInt(), tableHeight.toInt()); // ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©


                    },
                    child: Container(
                      width: 35,
                      height: 35,
                      color: Colors.red,
                    ),
                  ),
                ),
                Positioned(
                  top: 0,
                  left: 0,
                  child: GestureDetector(
                    onPanUpdate: (details) {
                      setState(() {
                        double newHeight = tableHeight - details.delta.dy;
                        double newWidth = tableWidth - details.delta.dx;

                        if (newHeight > 50) {
                          topOffset += details.delta.dy;
                          tableHeight = newHeight;
                        }
                        if (newWidth > 50) {
                          leftOffset += details.delta.dx;
                          tableWidth = newWidth;
                        }
                        tableWidth =
                            tableWidth.clamp(ballRadius + 30, 350);
                        tableHeight =
                            tableHeight.clamp(ballRadius + 30, 600);

                      });
                      updateBallPositionsAfterResize();
                    //  updateOverlaySize(tableWidth.toInt(), tableHeight.toInt()); // ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©

                    },
                    child: Container(
                      width: 35,
                      height: 35,
                      color: Colors.green,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }
}
